<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>一个人的小世界</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/github.css">
<meta name="generator" content="Hexo 7.3.0"></head>
<body>
  <header>
    <h1><a href="https://haixuxu.github.io">一个人的小世界</a></h1>
    <nav>
      
        <a href="/">Home</a>
      
        <a href="/archives">Archives</a>
      
    </nav>
  </header>
  <main>
    <article>
    <h2>记一次node-sass安装不成功的解决</h2>
    <p>2019-07-19</p>
    <div class="post-content">
      <h3 id="结论："><a href="#结论：" class="headerlink" title="结论："></a>结论：</h3><blockquote>
<p>node-sass安装过程：在指定的npm源上下载node-sass包，该包src目录包含了node-sass的npm包的C实现，<br>下载完node-sass包后安装该包的dependencies 指定的依赖, 然后执行package.json里面指定的install脚本和postinstall脚本,<br>install脚本检测是否存在编译好的二进制，没有的话到指定site下载的node-sass的二进制包，扩展名后缀为.node<br>postinstall脚本检测node-sass的二进制文件是否存在(带强制性参数–force时, 就是不管是否存在二进制都要编译C文件到二进制),不存在则使用node-gyp编译node-sass目录下的src目录，转到node-gyp脚本编译node-sass,<br>node-gyp编译node-sass前需要下载当前nodejs版本的头文件，用来编译node-sass的src目录下的C文件。编译成功则安装完成。</p>
</blockquote>
<h3 id="install脚本获取下载二进制地址函数和获取本地二进制函数"><a href="#install脚本获取下载二进制地址函数和获取本地二进制函数" class="headerlink" title="install脚本获取下载二进制地址函数和获取本地二进制函数"></a>install脚本获取下载二进制地址函数和获取本地二进制函数</h3><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getBinaryUrl</span>(<span class="hljs-params"></span>) &#123;
  <span class="hljs-keyword">var</span> site = <span class="hljs-title function_">getArgument</span>(<span class="hljs-string">&#x27;--sass-binary-site&#x27;</span>) ||
             process.<span class="hljs-property">env</span>.<span class="hljs-property">SASS_BINARY_SITE</span>  ||
             process.<span class="hljs-property">env</span>.<span class="hljs-property">npm_config_sass_binary_site</span> ||
             (pkg.<span class="hljs-property">nodeSassConfig</span> &amp;&amp; pkg.<span class="hljs-property">nodeSassConfig</span>.<span class="hljs-property">binarySite</span>) ||  <span class="hljs-comment">//可以配置在项目里面的package.json里面的nodeSassConfig字段</span>
             <span class="hljs-string">&#x27;https://github.com/sass/node-sass/releases/download&#x27;</span>;

  <span class="hljs-keyword">return</span> [site, <span class="hljs-string">&#x27;v&#x27;</span> + pkg.<span class="hljs-property">version</span>, <span class="hljs-title function_">getBinaryName</span>()].<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;/&#x27;</span>);
&#125;</code></pre>
<pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getBinaryPath</span>(<span class="hljs-params"></span>) &#123;
  <span class="hljs-keyword">var</span> binaryPath;

  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">getArgument</span>(<span class="hljs-string">&#x27;--sass-binary-path&#x27;</span>)) &#123;
    binaryPath = <span class="hljs-title function_">getArgument</span>(<span class="hljs-string">&#x27;--sass-binary-path&#x27;</span>);
  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">SASS_BINARY_PATH</span>) &#123;
    binaryPath = process.<span class="hljs-property">env</span>.<span class="hljs-property">SASS_BINARY_PATH</span>;
  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">npm_config_sass_binary_path</span>) &#123;
    binaryPath = process.<span class="hljs-property">env</span>.<span class="hljs-property">npm_config_sass_binary_path</span>;
  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pkg.<span class="hljs-property">nodeSassConfig</span> &amp;&amp; pkg.<span class="hljs-property">nodeSassConfig</span>.<span class="hljs-property">binaryPath</span>) &#123; <span class="hljs-comment">//可以配置在项目里面的package.json里面的nodeSassConfig字段</span>
    binaryPath = pkg.<span class="hljs-property">nodeSassConfig</span>.<span class="hljs-property">binaryPath</span>;
  &#125; <span class="hljs-keyword">else</span> &#123;
    binaryPath = path.<span class="hljs-title function_">join</span>(<span class="hljs-title function_">getBinaryDir</span>(), <span class="hljs-title function_">getBinaryName</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/_(?=binding\.node)/</span>, <span class="hljs-string">&#x27;/&#x27;</span>));
  &#125;

  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">versions</span>.<span class="hljs-property">modules</span> &lt; <span class="hljs-number">46</span>) &#123;
    <span class="hljs-keyword">return</span> binaryPath;
  &#125;

  <span class="hljs-keyword">try</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">trueCasePathSync</span>(binaryPath) || binaryPath;
  &#125; <span class="hljs-keyword">catch</span> (e) &#123;
    <span class="hljs-keyword">return</span> binaryPath;
  &#125;
&#125;</code></pre>

<p>使用远程服务器的二进制:</p>
<pre><code class="hljs sh">yarn config <span class="hljs-built_in">set</span> sass-binary-site http://npm.taobao.org/mirrors/node-sass
<span class="hljs-comment"># export SASS_BINARY_SITE=http://npm.taobao.org/mirrors/node-sass</span>
yarn add node-sass

<span class="hljs-comment"># 使用 --sass-binary-site</span>
yarn add node-sass   --sass-binary-site=http://npm.taobao.org/mirrors/node-sass</code></pre>



<p>使用本地的二进制: </p>
<pre><code class="hljs sh"><span class="hljs-comment">#export SASS_BINARY_PATH=/root/sass/linux-x64-67_binding.node</span>
yarn config <span class="hljs-built_in">set</span> sass_binary_path /root/sass/linux-x64-67_binding.node
yarn add node-sass

<span class="hljs-comment"># 使用 --sass-binary-path</span>
yarn add node-sass   --sass-binary-path=/root/sass/linux-x64-67_binding.node</code></pre>

<p>node-sass二进制文件下载地址:<a target="_blank" rel="noopener" href="https://github.com/sass/node-sass/releases">https://github.com/sass/node-sass/releases</a></p>
<p>使用本地二进制可能会有版本不兼容的问题。使用npm install <a href="mailto:&#110;&#111;&#100;&#101;&#45;&#115;&#97;&#115;&#115;&#64;&#x34;&#x2e;&#57;&#x2e;&#48;">&#110;&#111;&#100;&#101;&#45;&#115;&#97;&#115;&#115;&#64;&#x34;&#x2e;&#57;&#x2e;&#48;</a>  –sass-binary-path&#x3D;&#x2F;root&#x2F;sass&#x2F;linux-x64-64_binding.node –verbose</p>
<pre><code class="hljs sh">&gt; node-sass@4.9.0 postinstall /tmp/test/node_modules/node-sass
&gt; node scripts/build.js

Binary found at /root/sass/linux-x64-64_binding.node
Testing binary
Binary has a problem: Error: The module <span class="hljs-string">&#x27;/root/sass/linux-x64-64_binding.node&#x27;</span>
was compiled against a different Node.js version using
NODE_MODULE_VERSION 64. This version of Node.js requires
NODE_MODULE_VERSION 67. Please try re-compiling or re-installing</code></pre>

<p>说明下载下载的二进制版本编译而来的nodejs的ABI版本跟当前系统nodejs的ABI版本不匹配。<a target="_blank" rel="noopener" href="https://nodejs.org/zh-cn/download/releases/">ABI跟nodejs版本关系</a>linux-x64-64_binding  64即是ABI版本（感觉跟chrome版本。。。。) ,需要下载的67的 , <a target="_blank" rel="noopener" href="https://github.com/sass/node-sass/releases">下载地址</a></p>
<p>NODE_MODULE_VERSION 指的是 Node.js 的 ABI (application binary interface) 版本号，用来确定编译 Node.js 的 C++ 库版本，以确定是否可以直接加载而不需重新编译。在早期版本中其作为一位十六进制值来储存，而现在表示为一个整数。<a target="_blank" rel="noopener" href="https://nodejs.org/zh-cn/download/releases/">来自</a></p>
<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><p>错误信息</p>
<pre><code class="hljs plaintext">[4/4] Building fresh packages...
error /root/.jenkins/workspace/basp-web-client_master/node_modules/node-sass: Command failed.
Exit code: 1
Command: node scripts/build.js
Arguments: 
Directory: /root/.jenkins/workspace/basp-web-client_master/node_modules/node-sass
Output:
Building: /usr/local/bin/node /root/.jenkins/workspace/basp-web-client_master/node_modules/node-gyp/bin/node-gyp.js rebuild --verbose --libsass_ext= --libsass_cflags= --libsass_ldflags= --libsass_library=
gyp info it worked if it ends with ok
gyp verb cli [ &#x27;/usr/local/bin/node&#x27;,
gyp verb cli   &#x27;/root/.jenkins/workspace/basp-web-client_master/node_modules/node-gyp/bin/node-gyp.js&#x27;,
gyp verb cli   &#x27;rebuild&#x27;,
gyp verb cli   &#x27;--verbose&#x27;,
gyp verb cli   &#x27;--libsass_ext=&#x27;,
gyp verb cli   &#x27;--libsass_cflags=&#x27;,
gyp verb cli   &#x27;--libsass_ldflags=&#x27;,
gyp verb cli   &#x27;--libsass_library=&#x27; ]
gyp info using node-gyp@3.8.0
gyp info using node@11.6.0 | linux | x64
gyp verb command rebuild []
gyp verb command clean []
gyp verb clean removing &quot;build&quot; directory
gyp verb command configure []
gyp verb check python checking for Python executable &quot;python2&quot; in the PATH
gyp verb `which` succeeded python2 /usr/bin/python2
gyp verb check python version `/usr/bin/python2 -c &quot;import sys; print &quot;2.7.5
gyp verb check python version .%s.%s&quot; % sys.version_info[:3];&quot;` returned: %j
gyp verb get node dir no --target version specified, falling back to host node version: 11.6.0
gyp verb command install [ &#x27;11.6.0&#x27; ]
gyp verb install input version string &quot;11.6.0&quot;
gyp verb install installing version: 11.6.0
gyp verb install --ensure was passed, so won&#x27;t reinstall if already installed
gyp verb install version not already installed, continuing with install 11.6.0
gyp verb ensuring nodedir is created /root/.node-gyp/11.6.0
gyp verb created nodedir /root/.node-gyp
gyp http GET https://nodejs.org/download/release/v11.6.0/node-v11.6.0-headers.tar.gz
gyp WARN install got an error, rolling back install
gyp verb command remove [ &#x27;11.6.0&#x27; ]
gyp verb remove using node-gyp dir: /root/.node-gyp
gyp verb remove removing target version: 11.6.0
gyp verb remove removing development files for version: 11.6.0
gyp ERR! configure error 
gyp ERR! stack Error: connect ETIMEDOUT 104.20.22.46:443
gyp ERR! stack     at TCPConnectWrap.afterConnect [as oncomplete] (net.js:1082:14)
gyp ERR! System Linux 3.10.0-693.el7.x86_64
gyp ERR! command &quot;/usr/local/bin/node&quot; &quot;/root/.jenkins/workspace/basp-web-client_master/node_modules/node-gyp/bin/node-gyp.js&quot; &quot;rebuild&quot; &quot;--verbose&quot; &quot;--libsass_ext=&quot; &quot;--libsass_cflags=&quot; &quot;--libsass_ldflags=&quot; &quot;--libsass_library=&quot;
gyp ERR! cwd /root/.jenkins/workspace/basp-web-client_master/node_modules/node-sass
gyp ERR! node -v v11.6.0
gyp ERR! node-gyp -v v3.8.0
gyp ERR! not ok 
Build failed with error code: 1
info Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.
Build step &#x27;Execute shell&#x27; marked build as failure
Finished: FAILURE</code></pre>

<ol>
<li>尝试104.20.22.46  在线域名反向找到域名地址. 失败…</li>
<li>ping nodejs.org  。 IP地址是 104.20.22.46  真巧… , node_modules搜索nodejs.org….</li>
<li>检查服务器联网情况，pign 104.20.22.46   &#x2F; ping npm.taobao.org   超时… </li>
<li>google “stack Error: connect ETIMEDOUT 104.20.22.46:443” 是某一C模块问题.  一脸懵逼中。。。</li>
<li>“Exit code: 1<br>Command: node scripts&#x2F;build.js”  ????  查看node-sass package.json 查看scripts字段 包含install和postinstall</li>
</ol>
<pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span>
   <span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>
    <span class="hljs-attr">&quot;coverage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node scripts/coverage.js&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;install&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node scripts/install.js&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;postinstall&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node scripts/build.js&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;lint&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node_modules/.bin/eslint bin/node-sass lib scripts test&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node_modules/.bin/mocha test/&#123;*,**/**&#125;.js&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;build&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node scripts/build.js --force&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;prepublish&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;not-in-install &amp;&amp; node scripts/prepublish.js || in-install&quot;</span>
  <span class="hljs-punctuation">&#125;</span>
<span class="hljs-punctuation">&#125;</span></code></pre>

<p>查看scripts&#x2F;build.js </p>
<pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">testBinary</span>(<span class="hljs-params">options</span>) &#123;
  <span class="hljs-keyword">if</span> (options.<span class="hljs-property">force</span> || process.<span class="hljs-property">env</span>.<span class="hljs-property">SASS_FORCE_BUILD</span>) &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">build</span>(options);
  &#125;
<span class="hljs-comment">// 存在二进制？？？</span>
  <span class="hljs-keyword">if</span> (!sass.<span class="hljs-title function_">hasBinary</span>(sass.<span class="hljs-title function_">getBinaryPath</span>())) &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">build</span>(options);
  &#125;

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Binary found at&#x27;</span>, sass.<span class="hljs-title function_">getBinaryPath</span>());
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Testing binary&#x27;</span>);

  <span class="hljs-keyword">try</span> &#123;
      <span class="hljs-comment">//测试二进制有效???</span>
    <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;../&#x27;</span>).<span class="hljs-title function_">renderSync</span>(&#123;
      <span class="hljs-attr">data</span>: <span class="hljs-string">&#x27;s &#123; a: ss &#125;&#x27;</span>
    &#125;);

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Binary is fine&#x27;</span>);
  &#125; <span class="hljs-keyword">catch</span> (e) &#123; 
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Binary has a problem:&#x27;</span>, e);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Building the binary locally&#x27;</span>);
     <span class="hljs-comment">// 糟糕的二进制，还是要编译....</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">build</span>(options);
  &#125;
&#125;

<span class="hljs-title function_">testBinary</span>(<span class="hljs-title function_">parseArgs</span>(process.<span class="hljs-property">argv</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>)));</code></pre>

<p>查看scripts&#x2F;install.js</p>
<pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">checkAndDownloadBinary</span>(<span class="hljs-params"></span>) &#123;
  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">SKIP_SASS_BINARY_DOWNLOAD_FOR_CI</span>) &#123;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Skipping downloading binaries on CI builds&#x27;</span>);
    <span class="hljs-keyword">return</span>;
  &#125;

  <span class="hljs-keyword">var</span> cachedBinary = sass.<span class="hljs-title function_">getCachedBinary</span>(),
    cachePath = sass.<span class="hljs-title function_">getBinaryCachePath</span>(),
    binaryPath = sass.<span class="hljs-title function_">getBinaryPath</span>();  <span class="hljs-comment">// 获取配置的二进制文件路径</span>

  <span class="hljs-keyword">if</span> (sass.<span class="hljs-title function_">hasBinary</span>(binaryPath)) &#123;  <span class="hljs-comment">// 配置了二进制文件路径咱们就不下载了。。</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;node-sass build&#x27;</span>, <span class="hljs-string">&#x27;Binary found at&#x27;</span>, binaryPath);
    <span class="hljs-keyword">return</span>;
  &#125;

  <span class="hljs-keyword">try</span> &#123;
    mkdir.<span class="hljs-title function_">sync</span>(path.<span class="hljs-title function_">dirname</span>(binaryPath));
  &#125; <span class="hljs-keyword">catch</span> (err) &#123;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Unable to save binary&#x27;</span>, path.<span class="hljs-title function_">dirname</span>(binaryPath), <span class="hljs-string">&#x27;:&#x27;</span>, err);
    <span class="hljs-keyword">return</span>;
  &#125;

  <span class="hljs-keyword">if</span> (cachedBinary) &#123; <span class="hljs-comment">// 这是安装后执行第二次同样的安装...</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Cached binary found at&#x27;</span>, cachedBinary);
    fs.<span class="hljs-title function_">createReadStream</span>(cachedBinary).<span class="hljs-title function_">pipe</span>(fs.<span class="hljs-title function_">createWriteStream</span>(binaryPath));
    <span class="hljs-keyword">return</span>;
  &#125;

  <span class="hljs-comment">// 没有二进制乖乖下载吧。。。。。 getBinaryUrl解析了怎么拿到下载地址。。。</span>
  <span class="hljs-title function_">download</span>(sass.<span class="hljs-title function_">getBinaryUrl</span>(), binaryPath, <span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) &#123;
    <span class="hljs-keyword">if</span> (err) &#123;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
      <span class="hljs-keyword">return</span>;
    &#125;

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Binary saved to&#x27;</span>, binaryPath);

    cachedBinary = path.<span class="hljs-title function_">join</span>(cachePath, sass.<span class="hljs-title function_">getBinaryName</span>());

    <span class="hljs-keyword">if</span> (cachePath) &#123;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Caching binary to&#x27;</span>, cachedBinary);

      <span class="hljs-keyword">try</span> &#123;
        mkdir.<span class="hljs-title function_">sync</span>(path.<span class="hljs-title function_">dirname</span>(cachedBinary));
        fs.<span class="hljs-title function_">createReadStream</span>(binaryPath)
          .<span class="hljs-title function_">pipe</span>(fs.<span class="hljs-title function_">createWriteStream</span>(cachedBinary))
          .<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) &#123;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Failed to cache binary:&#x27;</span>, err);
          &#125;);
      &#125; <span class="hljs-keyword">catch</span> (err) &#123;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Failed to cache binary:&#x27;</span>, err);
      &#125;
    &#125;
  &#125;);
&#125;
 <span class="hljs-comment">// If binary does not exist, download it</span>
<span class="hljs-title function_">checkAndDownloadBinary</span>();</code></pre>

<p>最后回到上面的getBinaryPath和getBinaryUrl函数….</p>
<blockquote>
<p>tip 最后： sass已经出了dart写的版本dart-sass,新项目建议安装使用npm install sass –save-dev ,避免不必要的麻烦。。。</p>
</blockquote>

    </div>
  </article>
  
  
  </main>
  <footer>
    <p>&copy; 2024 xuxihai</p>
  </footer>

  <!-- 引入 Clipboard.js -->
  <script src="https://cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script>
  <script src="/js/linenumber.js"></script>
  <script src="/js/copy.js"></script>
</body>
</html>

