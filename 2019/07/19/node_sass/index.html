<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hexo</title>
  <link rel="stylesheet" href="/css/style.css">
<meta name="generator" content="Hexo 7.3.0"></head>
<body>
  <header>
    <h1><a href="https://haixuxu.github.io">Hexo</a></h1>
    <nav>
      
        <a href="/">Home</a>
      
        <a href="/archives">Archives</a>
      
    </nav>
  </header>
  <main>
    <article>
    <h2>记一次node-sass安装不成功的解决</h2>
    <p>2019-07-19</p>
    <div class="post-content">
      <h3 id="结论："><a href="#结论：" class="headerlink" title="结论："></a>结论：</h3><blockquote>
<p>node-sass安装过程：在指定的npm源上下载node-sass包，该包src目录包含了node-sass的npm包的C实现，<br>下载完node-sass包后安装该包的dependencies 指定的依赖, 然后执行package.json里面指定的install脚本和postinstall脚本,<br>install脚本检测是否存在编译好的二进制，没有的话到指定site下载的node-sass的二进制包，扩展名后缀为.node<br>postinstall脚本检测node-sass的二进制文件是否存在(带强制性参数–force时, 就是不管是否存在二进制都要编译C文件到二进制),不存在则使用node-gyp编译node-sass目录下的src目录，转到node-gyp脚本编译node-sass,<br>node-gyp编译node-sass前需要下载当前nodejs版本的头文件，用来编译node-sass的src目录下的C文件。编译成功则安装完成。</p>
</blockquote>
<h3 id="install脚本获取下载二进制地址函数和获取本地二进制函数"><a href="#install脚本获取下载二进制地址函数和获取本地二进制函数" class="headerlink" title="install脚本获取下载二进制地址函数和获取本地二进制函数"></a>install脚本获取下载二进制地址函数和获取本地二进制函数</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getBinaryUrl</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> site = <span class="title function_">getArgument</span>(<span class="string">&#x27;--sass-binary-site&#x27;</span>) ||</span><br><span class="line">             process.<span class="property">env</span>.<span class="property">SASS_BINARY_SITE</span>  ||</span><br><span class="line">             process.<span class="property">env</span>.<span class="property">npm_config_sass_binary_site</span> ||</span><br><span class="line">             (pkg.<span class="property">nodeSassConfig</span> &amp;&amp; pkg.<span class="property">nodeSassConfig</span>.<span class="property">binarySite</span>) ||  <span class="comment">//可以配置在项目里面的package.json里面的nodeSassConfig字段</span></span><br><span class="line">             <span class="string">&#x27;https://github.com/sass/node-sass/releases/download&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [site, <span class="string">&#x27;v&#x27;</span> + pkg.<span class="property">version</span>, <span class="title function_">getBinaryName</span>()].<span class="title function_">join</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getBinaryPath</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> binaryPath;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">getArgument</span>(<span class="string">&#x27;--sass-binary-path&#x27;</span>)) &#123;</span><br><span class="line">    binaryPath = <span class="title function_">getArgument</span>(<span class="string">&#x27;--sass-binary-path&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">SASS_BINARY_PATH</span>) &#123;</span><br><span class="line">    binaryPath = process.<span class="property">env</span>.<span class="property">SASS_BINARY_PATH</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">npm_config_sass_binary_path</span>) &#123;</span><br><span class="line">    binaryPath = process.<span class="property">env</span>.<span class="property">npm_config_sass_binary_path</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pkg.<span class="property">nodeSassConfig</span> &amp;&amp; pkg.<span class="property">nodeSassConfig</span>.<span class="property">binaryPath</span>) &#123; <span class="comment">//可以配置在项目里面的package.json里面的nodeSassConfig字段</span></span><br><span class="line">    binaryPath = pkg.<span class="property">nodeSassConfig</span>.<span class="property">binaryPath</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    binaryPath = path.<span class="title function_">join</span>(<span class="title function_">getBinaryDir</span>(), <span class="title function_">getBinaryName</span>().<span class="title function_">replace</span>(<span class="regexp">/_(?=binding\.node)/</span>, <span class="string">&#x27;/&#x27;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">versions</span>.<span class="property">modules</span> &lt; <span class="number">46</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> binaryPath;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">trueCasePathSync</span>(binaryPath) || binaryPath;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> binaryPath;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用远程服务器的二进制:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yarn config <span class="built_in">set</span> sass-binary-site http://npm.taobao.org/mirrors/node-sass</span><br><span class="line"><span class="comment"># export SASS_BINARY_SITE=http://npm.taobao.org/mirrors/node-sass</span></span><br><span class="line">yarn add node-sass</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 --sass-binary-site</span></span><br><span class="line">yarn add node-sass   --sass-binary-site=http://npm.taobao.org/mirrors/node-sass</span><br></pre></td></tr></table></figure>



<p>使用本地的二进制: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#export SASS_BINARY_PATH=/root/sass/linux-x64-67_binding.node</span></span><br><span class="line">yarn config <span class="built_in">set</span> sass_binary_path /root/sass/linux-x64-67_binding.node</span><br><span class="line">yarn add node-sass</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 --sass-binary-path</span></span><br><span class="line">yarn add node-sass   --sass-binary-path=/root/sass/linux-x64-67_binding.node</span><br></pre></td></tr></table></figure>

<p>node-sass二进制文件下载地址:<a target="_blank" rel="noopener" href="https://github.com/sass/node-sass/releases">https://github.com/sass/node-sass/releases</a></p>
<p>使用本地二进制可能会有版本不兼容的问题。使用npm install <a href="mailto:&#110;&#111;&#100;&#101;&#x2d;&#115;&#97;&#115;&#x73;&#x40;&#x34;&#46;&#57;&#46;&#48;">&#110;&#111;&#100;&#101;&#x2d;&#115;&#97;&#115;&#x73;&#x40;&#x34;&#46;&#57;&#46;&#48;</a>  –sass-binary-path&#x3D;&#x2F;root&#x2F;sass&#x2F;linux-x64-64_binding.node –verbose</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; node-sass@4.9.0 postinstall /tmp/test/node_modules/node-sass</span><br><span class="line">&gt; node scripts/build.js</span><br><span class="line"></span><br><span class="line">Binary found at /root/sass/linux-x64-64_binding.node</span><br><span class="line">Testing binary</span><br><span class="line">Binary has a problem: Error: The module <span class="string">&#x27;/root/sass/linux-x64-64_binding.node&#x27;</span></span><br><span class="line">was compiled against a different Node.js version using</span><br><span class="line">NODE_MODULE_VERSION 64. This version of Node.js requires</span><br><span class="line">NODE_MODULE_VERSION 67. Please try re-compiling or re-installing</span><br></pre></td></tr></table></figure>

<p>说明下载下载的二进制版本编译而来的nodejs的ABI版本跟当前系统nodejs的ABI版本不匹配。<a target="_blank" rel="noopener" href="https://nodejs.org/zh-cn/download/releases/">ABI跟nodejs版本关系</a>linux-x64-64_binding  64即是ABI版本（感觉跟chrome版本。。。。) ,需要下载的67的 , <a target="_blank" rel="noopener" href="https://github.com/sass/node-sass/releases">下载地址</a></p>
<p>NODE_MODULE_VERSION 指的是 Node.js 的 ABI (application binary interface) 版本号，用来确定编译 Node.js 的 C++ 库版本，以确定是否可以直接加载而不需重新编译。在早期版本中其作为一位十六进制值来储存，而现在表示为一个整数。<a target="_blank" rel="noopener" href="https://nodejs.org/zh-cn/download/releases/">来自</a></p>
<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><p>错误信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[4/4] Building fresh packages...</span><br><span class="line">error /root/.jenkins/workspace/basp-web-client_master/node_modules/node-sass: Command failed.</span><br><span class="line">Exit code: 1</span><br><span class="line">Command: node scripts/build.js</span><br><span class="line">Arguments: </span><br><span class="line">Directory: /root/.jenkins/workspace/basp-web-client_master/node_modules/node-sass</span><br><span class="line">Output:</span><br><span class="line">Building: /usr/local/bin/node /root/.jenkins/workspace/basp-web-client_master/node_modules/node-gyp/bin/node-gyp.js rebuild --verbose --libsass_ext= --libsass_cflags= --libsass_ldflags= --libsass_library=</span><br><span class="line">gyp info it worked if it ends with ok</span><br><span class="line">gyp verb cli [ &#x27;/usr/local/bin/node&#x27;,</span><br><span class="line">gyp verb cli   &#x27;/root/.jenkins/workspace/basp-web-client_master/node_modules/node-gyp/bin/node-gyp.js&#x27;,</span><br><span class="line">gyp verb cli   &#x27;rebuild&#x27;,</span><br><span class="line">gyp verb cli   &#x27;--verbose&#x27;,</span><br><span class="line">gyp verb cli   &#x27;--libsass_ext=&#x27;,</span><br><span class="line">gyp verb cli   &#x27;--libsass_cflags=&#x27;,</span><br><span class="line">gyp verb cli   &#x27;--libsass_ldflags=&#x27;,</span><br><span class="line">gyp verb cli   &#x27;--libsass_library=&#x27; ]</span><br><span class="line">gyp info using node-gyp@3.8.0</span><br><span class="line">gyp info using node@11.6.0 | linux | x64</span><br><span class="line">gyp verb command rebuild []</span><br><span class="line">gyp verb command clean []</span><br><span class="line">gyp verb clean removing &quot;build&quot; directory</span><br><span class="line">gyp verb command configure []</span><br><span class="line">gyp verb check python checking for Python executable &quot;python2&quot; in the PATH</span><br><span class="line">gyp verb `which` succeeded python2 /usr/bin/python2</span><br><span class="line">gyp verb check python version `/usr/bin/python2 -c &quot;import sys; print &quot;2.7.5</span><br><span class="line">gyp verb check python version .%s.%s&quot; % sys.version_info[:3];&quot;` returned: %j</span><br><span class="line">gyp verb get node dir no --target version specified, falling back to host node version: 11.6.0</span><br><span class="line">gyp verb command install [ &#x27;11.6.0&#x27; ]</span><br><span class="line">gyp verb install input version string &quot;11.6.0&quot;</span><br><span class="line">gyp verb install installing version: 11.6.0</span><br><span class="line">gyp verb install --ensure was passed, so won&#x27;t reinstall if already installed</span><br><span class="line">gyp verb install version not already installed, continuing with install 11.6.0</span><br><span class="line">gyp verb ensuring nodedir is created /root/.node-gyp/11.6.0</span><br><span class="line">gyp verb created nodedir /root/.node-gyp</span><br><span class="line">gyp http GET https://nodejs.org/download/release/v11.6.0/node-v11.6.0-headers.tar.gz</span><br><span class="line">gyp WARN install got an error, rolling back install</span><br><span class="line">gyp verb command remove [ &#x27;11.6.0&#x27; ]</span><br><span class="line">gyp verb remove using node-gyp dir: /root/.node-gyp</span><br><span class="line">gyp verb remove removing target version: 11.6.0</span><br><span class="line">gyp verb remove removing development files for version: 11.6.0</span><br><span class="line">gyp ERR! configure error </span><br><span class="line">gyp ERR! stack Error: connect ETIMEDOUT 104.20.22.46:443</span><br><span class="line">gyp ERR! stack     at TCPConnectWrap.afterConnect [as oncomplete] (net.js:1082:14)</span><br><span class="line">gyp ERR! System Linux 3.10.0-693.el7.x86_64</span><br><span class="line">gyp ERR! command &quot;/usr/local/bin/node&quot; &quot;/root/.jenkins/workspace/basp-web-client_master/node_modules/node-gyp/bin/node-gyp.js&quot; &quot;rebuild&quot; &quot;--verbose&quot; &quot;--libsass_ext=&quot; &quot;--libsass_cflags=&quot; &quot;--libsass_ldflags=&quot; &quot;--libsass_library=&quot;</span><br><span class="line">gyp ERR! cwd /root/.jenkins/workspace/basp-web-client_master/node_modules/node-sass</span><br><span class="line">gyp ERR! node -v v11.6.0</span><br><span class="line">gyp ERR! node-gyp -v v3.8.0</span><br><span class="line">gyp ERR! not ok </span><br><span class="line">Build failed with error code: 1</span><br><span class="line">info Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.</span><br><span class="line">Build step &#x27;Execute shell&#x27; marked build as failure</span><br><span class="line">Finished: FAILURE</span><br></pre></td></tr></table></figure>

<ol>
<li>尝试104.20.22.46  在线域名反向找到域名地址. 失败…</li>
<li>ping nodejs.org  。 IP地址是 104.20.22.46  真巧… , node_modules搜索nodejs.org….</li>
<li>检查服务器联网情况，pign 104.20.22.46   &#x2F; ping npm.taobao.org   超时… </li>
<li>google “stack Error: connect ETIMEDOUT 104.20.22.46:443” 是某一C模块问题.  一脸懵逼中。。。</li>
<li>“Exit code: 1<br>Command: node scripts&#x2F;build.js”  ????  查看node-sass package.json 查看scripts字段 包含install和postinstall</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;coverage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node scripts/coverage.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;install&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node scripts/install.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;postinstall&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node scripts/build.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node_modules/.bin/eslint bin/node-sass lib scripts test&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node_modules/.bin/mocha test/&#123;*,**/**&#125;.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node scripts/build.js --force&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;prepublish&quot;</span><span class="punctuation">:</span> <span class="string">&quot;not-in-install &amp;&amp; node scripts/prepublish.js || in-install&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查看scripts&#x2F;build.js </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">testBinary</span>(<span class="params">options</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (options.<span class="property">force</span> || process.<span class="property">env</span>.<span class="property">SASS_FORCE_BUILD</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">build</span>(options);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 存在二进制？？？</span></span><br><span class="line">  <span class="keyword">if</span> (!sass.<span class="title function_">hasBinary</span>(sass.<span class="title function_">getBinaryPath</span>())) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">build</span>(options);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Binary found at&#x27;</span>, sass.<span class="title function_">getBinaryPath</span>());</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Testing binary&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//测试二进制有效???</span></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&#x27;../&#x27;</span>).<span class="title function_">renderSync</span>(&#123;</span><br><span class="line">      <span class="attr">data</span>: <span class="string">&#x27;s &#123; a: ss &#125;&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Binary is fine&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123; </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Binary has a problem:&#x27;</span>, e);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Building the binary locally&#x27;</span>);</span><br><span class="line">     <span class="comment">// 糟糕的二进制，还是要编译....</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">build</span>(options);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">testBinary</span>(<span class="title function_">parseArgs</span>(process.<span class="property">argv</span>.<span class="title function_">slice</span>(<span class="number">2</span>)));</span><br></pre></td></tr></table></figure>

<p>查看scripts&#x2F;install.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkAndDownloadBinary</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">SKIP_SASS_BINARY_DOWNLOAD_FOR_CI</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Skipping downloading binaries on CI builds&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> cachedBinary = sass.<span class="title function_">getCachedBinary</span>(),</span><br><span class="line">    cachePath = sass.<span class="title function_">getBinaryCachePath</span>(),</span><br><span class="line">    binaryPath = sass.<span class="title function_">getBinaryPath</span>();  <span class="comment">// 获取配置的二进制文件路径</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sass.<span class="title function_">hasBinary</span>(binaryPath)) &#123;  <span class="comment">// 配置了二进制文件路径咱们就不下载了。。</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;node-sass build&#x27;</span>, <span class="string">&#x27;Binary found at&#x27;</span>, binaryPath);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    mkdir.<span class="title function_">sync</span>(path.<span class="title function_">dirname</span>(binaryPath));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unable to save binary&#x27;</span>, path.<span class="title function_">dirname</span>(binaryPath), <span class="string">&#x27;:&#x27;</span>, err);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cachedBinary) &#123; <span class="comment">// 这是安装后执行第二次同样的安装...</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Cached binary found at&#x27;</span>, cachedBinary);</span><br><span class="line">    fs.<span class="title function_">createReadStream</span>(cachedBinary).<span class="title function_">pipe</span>(fs.<span class="title function_">createWriteStream</span>(binaryPath));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 没有二进制乖乖下载吧。。。。。 getBinaryUrl解析了怎么拿到下载地址。。。</span></span><br><span class="line">  <span class="title function_">download</span>(sass.<span class="title function_">getBinaryUrl</span>(), binaryPath, <span class="keyword">function</span>(<span class="params">err</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Binary saved to&#x27;</span>, binaryPath);</span><br><span class="line"></span><br><span class="line">    cachedBinary = path.<span class="title function_">join</span>(cachePath, sass.<span class="title function_">getBinaryName</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cachePath) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Caching binary to&#x27;</span>, cachedBinary);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        mkdir.<span class="title function_">sync</span>(path.<span class="title function_">dirname</span>(cachedBinary));</span><br><span class="line">        fs.<span class="title function_">createReadStream</span>(binaryPath)</span><br><span class="line">          .<span class="title function_">pipe</span>(fs.<span class="title function_">createWriteStream</span>(cachedBinary))</span><br><span class="line">          .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Failed to cache binary:&#x27;</span>, err);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Failed to cache binary:&#x27;</span>, err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">// If binary does not exist, download it</span></span><br><span class="line"><span class="title function_">checkAndDownloadBinary</span>();</span><br></pre></td></tr></table></figure>

<p>最后回到上面的getBinaryPath和getBinaryUrl函数….</p>
<blockquote>
<p>tip 最后： sass已经出了dart写的版本dart-sass,新项目建议安装使用npm install sass –save-dev ,避免不必要的麻烦。。。</p>
</blockquote>

    </div>
  </article>
  
  
  </main>
  <footer>
    <p>&copy; 2024 John Doe</p>
  </footer>
</body>
</html>

